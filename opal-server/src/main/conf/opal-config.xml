<org.obiba.opal.core.cfg.OpalConfiguration>

  <secretKey>this will be generated during install</secretKey>

  <fileSystemRoot>file://${OPAL_HOME}/fs</fileSystemRoot>

  <functionalUnits>
  </functionalUnits>

  <magmaEngineFactory>

    <extensions>
      <org.obiba.magma.js.MagmaJsExtension/>
      <org.obiba.magma.xstream.MagmaXStreamExtension/>
      <org.obiba.magma.security.MagmaSecurityExtension/>
    </extensions>

    <factories>
      <org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>
        <name>opal-data</name>
        <sessionFactoryProvider class="org.obiba.magma.datasource.hibernate.support.SpringBeanSessionFactoryProvider">
          <beanName>opalSessionFactory</beanName>
        </sessionFactoryProvider>
      </org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>
    </factories>
  </magmaEngineFactory>

  <extensions>
    <org.obiba.opal.datashield.cfg.DatashieldConfiguration>
      <level>RESTRICTED</level>
      <environments>
        <org.obiba.opal.datashield.DataShieldEnvironment>
          <environment>ASSIGN</environment>
          <methods>
            <org.obiba.opal.datashield.RFunctionDataShieldMethod>
              <name>log</name>
              <function>base::log</function>
            </org.obiba.opal.datashield.RFunctionDataShieldMethod>
          </methods>
        </org.obiba.opal.datashield.DataShieldEnvironment>
        <org.obiba.opal.datashield.DataShieldEnvironment>
          <environment>AGGREGATE</environment>
          <methods>
            <org.obiba.opal.datashield.RFunctionDataShieldMethod>
              <name>length</name>
              <function>base::length</function>
            </org.obiba.opal.datashield.RFunctionDataShieldMethod>
            <org.obiba.opal.datashield.RFunctionDataShieldMethod>
              <name>c</name>
              <function>base::c</function>
            </org.obiba.opal.datashield.RFunctionDataShieldMethod>
            <org.obiba.opal.datashield.CustomRScriptMethod>
              <name>summary</name>
              <script><![CDATA[function(data) {
  if(is.atomic(data)) {
    if(length(data) <= 1) {
      "Vector too small."
    } else {
      base::summary(data);
    }
  } else if(is.recursive(data)) {
      base::summary.default(data);
  }
}]]>
              </script>
            </org.obiba.opal.datashield.CustomRScriptMethod>

            <org.obiba.opal.datashield.CustomRScriptMethod>
              <name>lm.ds</name>
              <script><![CDATA[function(data) {
  if(inherits(data, 'lm')) {
   sum.lm <- stats::summary.lm(data)
   list(
     coefficients=sum.lm$coefficients,
     numsubs=length(sum.lm$residuals)
   )
 } else {
  NULL
 }
}]]></script>
            </org.obiba.opal.datashield.CustomRScriptMethod>

            <org.obiba.opal.datashield.CustomRScriptMethod>
              <name>glm.ds</name>
              <script><![CDATA[function (formula, family, beta.vect=NULL) {

  mod.glm.ds <- glm(formula, family=family, x=TRUE, control=glm.control(maxit=1))

  X.mat <- as.matrix(mod.glm.ds$x)

  if(is.null(beta.vect)) {
    beta.vect <- rep(0,dim(X.mat)[2])
  }

  numsubs<-dim(X.mat)[1]

  y.vect<-as.vector(mod.glm.ds$y)

  lp.vect<-X.mat%*%beta.vect

  f<-mod.glm.ds$family

  mu.vect<-f$linkinv(lp.vect)
  mu.eta.val<-f$mu.eta(lp.vect)
  var.vect<-f$variance(mu.vect)
  dev<-sum(f$dev.resids(y.vect, mu.vect, rep(1, length(y.vect))))

  W.vect<-as.vector(mu.eta.val^2/var.vect)
  WX.mat<-W.vect*X.mat
  info.matrix<-t(X.mat)%*%WX.mat

  u.vect<-(y.vect-mu.vect)*1/var.vect
  W.u.mat<-matrix(W.vect*u.vect)
  score.vect<-t(X.mat)%*%W.u.mat

  list(family=f, info.matrix=info.matrix, score.vect=score.vect, numsubs=numsubs, dev=dev)
}]]></script>
            </org.obiba.opal.datashield.CustomRScriptMethod>
          </methods>
        </org.obiba.opal.datashield.DataShieldEnvironment>
      </environments>
    </org.obiba.opal.datashield.cfg.DatashieldConfiguration>
  </extensions>
</org.obiba.opal.core.cfg.OpalConfiguration>