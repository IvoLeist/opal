<org.obiba.opal.core.cfg.OpalConfiguration>
  <fileSystemRoot>/home/tdebat/opalfs</fileSystemRoot>

  <functionalUnits>
    <org.obiba.opal.core.unit.FunctionalUnit>
     <name>OHS-unit</name>
     <keyVariableName>my-key</keyVariableName>
     <!--
     <select class="org.obiba.magma.js.views.JavascriptClause">
       <script>name().matches(/BoneDensity.InstrumentRun.Contraindication.code/).or(attribute('identifier').isNull().not().and(attribute('identifier').matches(/true/)))</script>
     </select>
     -->
   </org.obiba.opal.core.unit.FunctionalUnit>

    <org.obiba.opal.core.unit.FunctionalUnit>
     <name>CAG-unit</name>
     <keyVariableName>my-key</keyVariableName>
   </org.obiba.opal.core.unit.FunctionalUnit>
  </functionalUnits>

  <magmaEngineFactory>
<!--
    <engineClass>org.obiba.magma.MagmaEngine</engineClass>
-->

    <extensions>
      <org.obiba.magma.js.MagmaJsExtension />
      <org.obiba.magma.xstream.MagmaXStreamExtension />
    </extensions>
    
    <factories>

      <org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>
        <name>opal-keys</name>
        <sessionFactoryProvider class="org.obiba.magma.datasource.hibernate.support.SpringBeanSessionFactoryProvider">
          <beanName>keySessionFactory</beanName>
        </sessionFactoryProvider>
      </org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>

      <org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>
        <name>opal-data</name>
        <sessionFactoryProvider class="org.obiba.magma.datasource.hibernate.support.SpringBeanSessionFactoryProvider">
          <beanName>opalSessionFactory</beanName>
        </sessionFactoryProvider>
      </org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>

      <org.obiba.magma.datasource.jdbc.JdbcDatasourceFactory>
        <name>cpt-mart</name>
        <jdbcProperties>
          <property name="driverClassName" value="com.mysql.jdbc.Driver" />
          <property name="url" value="jdbc:mysql://localhost:3306/opal10jdbc" />
          <property name="username" value="user" />
          <property name="password" value="abc123" />
        </jdbcProperties>
        <settings>
          <defaultEntityType>Participant</defaultEntityType>
          <defaultCreatedTimestampColumnName>created</defaultCreatedTimestampColumnName>
          <defaultUpdatedTimestampColumnName>updated</defaultUpdatedTimestampColumnName>
        </settings>
      </org.obiba.magma.datasource.jdbc.JdbcDatasourceFactory>

      <org.obiba.magma.datasource.jdbc.JdbcDatasourceFactory>
        <name>jdbc2</name>
        <jdbcProperties>
          <property name="driverClassName" value="com.mysql.jdbc.Driver" />
          <property name="url" value="jdbc:mysql://localhost:3306/opal10jdbc2" />
          <property name="username" value="user" />
          <property name="password" value="abc123" />
        </jdbcProperties>
        <settings>
          <defaultEntityType>Participant</defaultEntityType>
          <useMetadataTables>TRUE</useMetadataTables>
        </settings>
      </org.obiba.magma.datasource.jdbc.JdbcDatasourceFactory>

      <org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>
        <name>two words</name>
        <sessionFactoryProvider class="org.obiba.magma.datasource.hibernate.support.SpringBeanSessionFactoryProvider">
          <beanName>opalSessionFactory</beanName>
        </sessionFactoryProvider>
        <transformer class="org.obiba.magma.views.support.ViewAwareDatasourceTransformer">
          <name>two wordsViews</name>
          <views>
            <view class="org.obiba.magma.views.View">
              <name>BooleanView</name>
              <select class="org.obiba.magma.js.views.JavascriptClause">
                <script>name().matches(/CIPreliminaryQuestionnaire.ABLE_TO_STAND.*/)</script>
              </select>
              <from class="org.obiba.magma.support.ValueTableReference">
                <reference>two wordsViews.Participants</reference>
              </from>
            </view>
          </views>
        </transformer>
      </org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>

      <org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>
        <name>starbucks</name>
        <sessionFactoryProvider class="org.obiba.magma.datasource.hibernate.support.SpringBeanSessionFactoryProvider">
          <beanName>opalSessionFactory</beanName>
        </sessionFactoryProvider>
        <transformer class="org.obiba.magma.views.support.ViewAwareDatasourceTransformer">
          <name>starbucks-views</name>
          <views>
            <view class="org.obiba.magma.views.View">
              <name>BooleanView</name>
              <select class="org.obiba.magma.js.views.JavascriptClause">
                <script>name().matches(/CIPreliminaryQuestionnaire.ABLE_TO_STAND.*/, /BoneDensity.*/)</script>
              </select>
              <from class="org.obiba.magma.support.ValueTableReference">
                <reference>foo.Participants</reference>
              </from>
            </view>
            <view class="org.obiba.magma.views.View">
              <name>AdminView</name>
              <select class="org.obiba.magma.js.views.JavascriptClause">
                <script>name().matches(/Admin.Participant.*/)</script>
              </select>
              <from class="org.obiba.magma.support.ValueTableReference">
                <reference>foo.Participants</reference>
              </from>
            </view>
            <view class="org.obiba.magma.views.View">
              <name>CIView</name>
              <select class="org.obiba.magma.js.views.JavascriptClause">
                <script>name().matches(/CIPreliminaryQuestionnaire.ABLE_TO_STAND.*/)</script>
              </select>
              <from class="org.obiba.magma.support.ValueTableReference">
                <reference>foo.Participants</reference>
              </from>
            </view>
          </views>
        </transformer>
      </org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>

      <org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>
        <name>robin</name>
        <sessionFactoryProvider class="org.obiba.magma.datasource.hibernate.support.SpringBeanSessionFactoryProvider">
          <beanName>opalSessionFactory</beanName>
        </sessionFactoryProvider>
        <transformer class="org.obiba.magma.views.support.ViewAwareDatasourceTransformer">
          <name>my-datasource-with-views</name>
          <views>
            <view class="org.obiba.magma.views.View">
              <name>MySmokersView</name>
              <select class="org.obiba.magma.js.views.JavascriptClause">
                <script>variable().name().matches(/Participant.*/, /DO_YOU_SMOKE/)</script>
              </select>
              <from class="org.obiba.magma.support.ValueTableReference">
                <reference>my-datasource.Participants</reference>
              </from>
              <where class="org.obiba.magma.js.views.JavascriptClause">
                <script>$('DO_YOU_SMOKE').any('DNK', 'PNA').not()</script>
              </where>
            </view>
          </views>
        </transformer>
      </org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>

      <org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>
        <name>dylan</name>
        <sessionFactoryProvider class="org.obiba.magma.datasource.hibernate.support.SpringBeanSessionFactoryProvider">
          <beanName>opalSessionFactory</beanName>
        </sessionFactoryProvider>
        <transformer class="org.obiba.magma.views.support.ViewAwareDatasourceTransformer">
          <name>dylan-views</name>
          <views>
            <view class="org.obiba.magma.views.View">
              <name>DerivedView</name>
                <variables class="org.obiba.magma.js.views.VariablesClause">
		  <variables>


		    <variable name="GENERIC_128" valueType="integer" entityType="Participant">
		      <attributes>
			<attribute name="label" valueType="text" locale="en">Appointment Year</attribute>
			<attribute name="URI" valueType="text">http://www.datashaper.org/owl/2009/10/generic.owl#GENERIC_128</attribute>
			<attribute name="script" valueType="text">$('Admin.Participant.appointmentDate').year()</attribute>
		      </attributes>
		    </variable>


		    <variable name="GENERIC_GENDER" valueType="text" entityType="Participant">
		      <attributes>
			<attribute name="label" valueType="text" locale="en">Gender</attribute>
			<attribute name="URI" valueType="text">http://www.datashaper.org/owl/2009/10/generic.owl#GENERIC_GENDER</attribute>
			<attribute name="script" valueType="text">$('Admin.Participant.gender')</attribute>
		      </attributes>
		    </variable>

		    <variable name="DOUBLE_YEAR" valueType="integer" entityType="Participant">
		      <attributes>
			<attribute name="label" valueType="text" locale="en">Double Year</attribute>
			<attribute name="URI" valueType="text">http://www.datashaper.org/owl/2009/10/generic.owl#BIG_YEAR</attribute>
			<attribute name="script" valueType="text">$('Admin.Participant.birthYear').plus($('Admin.Participant.birthYear'))</attribute>
		      </attributes>
		    </variable>

		    <variable name="GENERIC_BIRTH_YEAR" valueType="integer" entityType="Participant">
		      <attributes>
			<attribute name="sameAs" valueType="text">Admin.Participant.birthYear</attribute>
		      </attributes>
		    </variable>


		    <variable name="AGE_AT_APPOINTMENT" valueType="integer" entityType="Participant">
		      <attributes>
			<attribute name="sameAs" valueType="text">Admin.Participant.birthYear</attribute>
			<attribute name="script" valueType="text">$('Admin.Participant.appointmentDate').year().minus($('Admin.Participant.birthYear'))</attribute>
		      </attributes>
		    </variable>

		    <variable name="AGE_CATEGORY_WITH_ELSE" valueType="integer" entityType="Participant">
		      <attributes>
			<attribute name="script" valueType="text">

<![CDATA[
function ageCategory() {
        var appDate = $('Admin.Participant.appointmentDate');
        var appDateBool = appDate.type('boolean');
        log("appDate.type()={}  age.type('boolean').type()={}   what={}", appDate.type(), appDate.type('boolean').type(), appDateBool);
	var age = $('Admin.Participant.appointmentDate').year().minus($('Admin.Participant.birthYear'));
        
 
        log("age.type()={}  age.type('text').type()={}", age.type(), age.type('text').type());
	if(age.value() < 30) {
		return age.plus(age);
	} else {
		return age.plus(age).plus(age);
	}
}
ageCategory();
]]>

</attribute>
		      </attributes>
		    </variable>


		    <variable name="GENDER_COMMENT" valueType="text" entityType="Participant">
		      <attributes>
			<attribute name="script" valueType="text">

<![CDATA[
log('gender {}', $('Admin.Participant.gender'));
function genderComment() {
   switch($('Admin.Participant.gender').value) {
      case "MALE":
         return $('Admin.Participant.gender').concat(": The participant is male.");
      case "FEMALE":
         return $('Admin.Participant.gender').concat(": The participant is female.");
      default:
         return $('Admin.Participant.gender').concat(": The participant gender is unexpected.");
   }
}
log('genderComment() {}', genderComment());
genderComment();
]]>

</attribute>
		      </attributes>
		    </variable>



                  </variables>
              </variables>
              <from class="org.obiba.magma.support.ValueTableReference">
                <reference>foo.Participants</reference>
              </from>
            </view>
          </views>
        </transformer>
      </org.obiba.magma.datasource.hibernate.support.HibernateDatasourceFactory>




    </factories>
  </magmaEngineFactory>
</org.obiba.opal.core.cfg.OpalConfiguration>
